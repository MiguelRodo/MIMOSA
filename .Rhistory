p<-p.adjust(p,"fdr")
truth<-gl(2,50)%in%2
th<-seq(0,1,l=1000)
tpr<-sapply(th,function(x){
sum((p<=x)[truth])
})/sum(truth)
fpr<-sapply(th,function(x){
sum((p<=x)[!truth])
})/sum(!truth)
data.frame(TPR=tpr,FPR=fpr,Ntot=names(result)[j])
}))
ROC<-cbind(rbind(ROC,ROC.fisher),Method=gl(2,3000,labels=c("MIMOSA","Fisher")))
ggplot(ROC)+geom_line(aes(x=FPR,y=TPR,color=Method),lwd=1.5)+facet_wrap(~Ntot)+theme_bw()
library(MIMOSA)
suppressPackageStartupMessages(require(MIMOSA))
set.seed(100)
effect.sizes.fold<-c(3,3,3)
NN<-c(50000,40000,20000)
#Nobs<-rep(NN,3)
Nobs<-200000
pu<-rep(2e-4,3)
ps<-pu*effect.sizes.fold
As<-ps*Nobs
Bs<-(Nobs-As)
A0<-pu*Nobs
B0<-(Nobs-A0)
ANTIGEN.STIM<-c("ENV","GAG","POL")
ANTIGEN.UNSTIM<-c("negctrl","negctrl","negctrl")
CYTOKINE=c("IFNg","IFNg","IFNg")
Ncells<-NN
TCELLSUB=c("CD4")
obs<-100
Nobs<-NN
j<-1
ICS<-do.call(rbind,lapply(seq_along(Nobs),function(i){
sim<-MIMOSA:::simulate2(obs=obs,As=As[j],Bs=Bs[j],A0=A0[j],B0=B0[j],NS=NN[i],N0=NN[i],w2=0.5,alternative="greater")
stim<-sim[,c("Ns","ns")]
unstim<-sim[,c("Nu","nu")]
colnames(stim)<-c("NSUB","CYTNUM")
colnames(unstim)<-c("NSUB","CYTNUM")
df<-rbind(stim,unstim)
data.frame(df,ANTIGEN=gl(2,obs,labels=c(ANTIGEN.STIM[i],ANTIGEN.UNSTIM[i])),CYTOKINE=CYTOKINE[i],TCELLSUBSET=TCELLSUB[1],UID=rep(gl(obs,1),2))
}))
ICS<-cbind(ICS,Ntot=factor(ICS$NSUB+ICS$CYTNUM))
ggplot(ICS)+geom_histogram(aes(x=CYTNUM,fill=(ANTIGEN%in%"negctrl")),alpha=0.5,position="identity")+facet_wrap(~Ntot)+scale_fill_discrete("negative control")
require(MIMOSA)
head(ICS)
E<-ConstructMIMOSAExpressionSet(ICS,
reference=ANTIGEN%in%"negctrl",measure.columns=c("CYTNUM","NSUB"),
other.annotations=c("CYTOKINE","TCELLSUBSET","ANTIGEN","UID","Ntot"),
default.cast.formula=component~UID+ANTIGEN+CYTOKINE+TCELLSUBSET+Ntot,
.variables=.(TCELLSUBSET,CYTOKINE,UID,Ntot),
featureCols=1,ref.append.replace="_REF")
set.seed(100)
result<-MIMOSA(NSUB+CYTNUM~UID+TCELLSUBSET+CYTOKINE+Ntot|ANTIGEN,
data=E,
#                subset=RefTreat%in%"Treatment",
#                ref=RefTreat%in%"Reference",
method="EM",iter=150000,burn=50000,pXi=1,EXPRATE=1e-7)
result
names(result)<-unlist(lapply(result,function(x)unique(pData(x)$Ntot)))
lapply(result,function(x){
Tbl<-table(fdr(x@z)<0.01)
})
lapply(result,function(x)x@w)
q<- as.vector(sapply(1:3,function(i)-log10(fdr(result[[i]]@z))))
ps<-as.vector(sapply(1:3,function(i)prop.table(as.matrix(result[[i]]@result@data$n.stim),1)[,2]))
pu<-as.vector(sapply(1:3,function(i)prop.table(as.matrix(result[[i]]@result@data$n.unstim),1)[,2]))
p.stim<-as.vector(sapply(1:3,function(i)result[[i]]@z[,2]))
df<-data.frame(p.stim,q,ps,pu,Ntot=gl(3,100,labels=names(result)))
ggplot(df)+geom_point(aes(x=ps-pu,y=p.stim))+theme_bw()+scale_y_continuous("Probability of Stimulation")+facet_wrap(~Ntot)
ROC<-do.call(rbind,lapply(seq_along(result),function(i){
stat<-MIMOSA:::fdr(result[[i]]@z)
truth<-gl(2,50)%in%2
th<-seq(0,1,l=1000)
tpr<-sapply(th,function(x){
sum((stat<=x)[truth])
})
tpr<-tpr/sum(truth)
fpr<-sapply(th,function(x){
sum((stat<=x)[!truth])
})
fpr<-fpr/sum(!truth)
data.frame(TPR=tpr,FPR=fpr,Ntot=names(result)[i])
}))
ggplot(ROC)+geom_line(aes(x=FPR,y=TPR,color=Ntot),lwd=1.5)+theme_bw()
ROC.fisher<-do.call(rbind,lapply(seq_along(result),function(j){
p<-vector('numeric',100)
for(i in 1:100){
p[i]<-fisher.test(as.matrix(rbind(result[[j]]@result@data$n.unstim[i,],result[[j]]@result@data$n.stim[i,])),alternative="greater")$p
}
p<-p.adjust(p,"fdr")
truth<-gl(2,50)%in%2
th<-seq(0,1,l=1000)
tpr<-sapply(th,function(x){
sum((p<=x)[truth])
})/sum(truth)
fpr<-sapply(th,function(x){
sum((p<=x)[!truth])
})/sum(!truth)
data.frame(TPR=tpr,FPR=fpr,Ntot=names(result)[j])
}))
ROC<-cbind(rbind(ROC,ROC.fisher),Method=gl(2,3000,labels=c("MIMOSA","Fisher")))
ggplot(ROC)+geom_line(aes(x=FPR,y=TPR,color=Method),lwd=1.5)+facet_wrap(~Ntot)+theme_bw()
setwd("~/Downloads/mimosahelp")
library(MIMOSA)
library(data.table)
data<-fread("mimosaSetRMMC.csv")
data[,VISITNO:=factor(VISITNO)]
data[,PTID:=factor(PTID)]
data[,ANTIGEN:=factor(ANTIGEN)]
data[,TCELLSUB:=factor(TCELLSUB)]
data[,SAMPLETYPE:=factor(SAMPLETYPE)]
data[,CYTOKINE:=factor(CYTOKINE)]
data[,TESTDT:=factor(TESTDT)]
data[,ASSAYID:=factor(ASSAYID)]
data[,NSUB:=as.numeric(NSUB)]
data[,CYTNUM:=as.numeric(CYTNUM)]
data[,NSUB_NEG:=as.numeric(NSUB_NEG)]
data[,CYTNUM_NEG:=as.numeric(CYTNUM_NEG)]
MIMOSA_THRESHOLD_FDR<-0.01
E<-ConstructMIMOSAExpressionSet(data,reference=NULL,measure.columns=c("NSUB","CYTNUM"),.variables=.(PTID,ANTIGEN,TCELLSUB,SAMPLETYPE,CYTOKINE,VISITNO,TESTDT,ASSAYID))
result<-MIMOSA(NSUB+CYTNUM~PTID+CYTOKINE+ASSAYID|TCELLSUB+VISITNO+ANTIGEN,E,method="mcmc")
list.files()
list.files(pattern="dat*")
sapply(list.files(pattern="dat*"),file.remove)
result<-MIMOSA(NSUB+CYTNUM~PTID+CYTOKINE+ASSAYID|TCELLSUB+VISITNO+ANTIGEN,E,method="EM")
res.full<-ddply(do.call(rbind,lapply(result,function(r)do.call(rbind,lapply(r,function(tc){
cbind(pData(tc),effect={
if(class(tc@result)=="MDMixResult"){
prop.table(as.matrix(tc@result@data$n.stim),1)[,2]-prop.table(as.matrix(tc@result@data$n.unstim),1)[,2]
}else{
prop.table(as.matrix(tc@result@n.stim),1)[,2]-prop.table(as.matrix(tc@result@n.unstim),1)[,2]
}
},Pr_nonresp=tc@z[,1],Pr_resp=tc@z[,2])})))),.(PTID,TCELLSUB,ASSAYID),transform,fdr_antigen=MIMOSA:::fdr(cbind(Pr_nonresp,Pr_resp)),Mimosa.call=MIMOSA:::fdr(cbind(Pr_nonresp,Pr_resp))<MIMOSA_THRESHOLD_FDR)
lresult<-list(result)
res.full<-ddply(do.call(rbind,lapply(result,function(r)do.call(rbind,lapply(r,function(tc){
cbind(pData(tc),effect={
if(class(tc@result)=="MDMixResult"){
prop.table(as.matrix(tc@result@data$n.stim),1)[,2]-prop.table(as.matrix(tc@result@data$n.unstim),1)[,2]
}else{
prop.table(as.matrix(tc@result@n.stim),1)[,2]-prop.table(as.matrix(tc@result@n.unstim),1)[,2]
}
},Pr_nonresp=tc@z[,1],Pr_resp=tc@z[,2])})))),.(PTID,TCELLSUB,ASSAYID),transform,fdr_antigen=MIMOSA:::fdr(cbind(Pr_nonresp,Pr_resp)),Mimosa.call=MIMOSA:::fdr(cbind(Pr_nonresp,Pr_resp))<MIMOSA_THRESHOLD_FDR)
result<-list(result)
res.full<-ddply(do.call(rbind,lapply(result,function(r)do.call(rbind,lapply(r,function(tc){
cbind(pData(tc),effect={
if(class(tc@result)=="MDMixResult"){
prop.table(as.matrix(tc@result@data$n.stim),1)[,2]-prop.table(as.matrix(tc@result@data$n.unstim),1)[,2]
}else{
prop.table(as.matrix(tc@result@n.stim),1)[,2]-prop.table(as.matrix(tc@result@n.unstim),1)[,2]
}
},Pr_nonresp=tc@z[,1],Pr_resp=tc@z[,2])})))),.(PTID,TCELLSUB,ASSAYID),transform,fdr_antigen=MIMOSA:::fdr(cbind(Pr_nonresp,Pr_resp)),Mimosa.call=MIMOSA:::fdr(cbind(Pr_nonresp,Pr_resp))<MIMOSA_THRESHOLD_FDR)
with(res.full,if(all(Pr_nonresp==fdr_antigen)){
warning("The FDR is equal to the probability of non-response.\nUnless you are adjusting over one antigen something may have gone wrong.");
})
colnames(res.full)<-tolower(colnames(res.full))
write.table(res.full,file="mimosaSetRMMC_result.csv",sep=",",row.names=FALSE,quote=FALSE)
ggplot(res.full)+geom_point(aes(x=effect,y=pr_resp,col=mimosa.call))+facet_grid(visitno~antigen+tcellsub)
getwd()
setwd("..")
setwd("~/Downloads/mimosahelp")
library(MIMOSA)
library(data.table)
infiles<-list.files(pattern="csv")
infiles<-infiles[!grepl("result",infiles)]
outfiles<-gsub("\\.csv","_result.csv",infiles)
infile<-infiles[k]
outfile<-outfiles[k]
data<-fread(infile)
data[,VISITNO:=factor(VISITNO)]
data[,PTID:=factor(PTID)]
k<-2
infile<-infiles[k]
outfile<-outfiles[k]
data<-fread(infile)
data[,VISITNO:=factor(VISITNO)]
data[,PTID:=factor(PTID)]
data[,ANTIGEN:=factor(ANTIGEN)]
data[,TCELLSUB:=factor(TCELLSUB)]
data[,SAMPLETYPE:=factor(SAMPLETYPE)]
data[,CYTOKINE:=factor(CYTOKINE)]
data[,TESTDT:=factor(TESTDT)]
data[,ASSAYID:=factor(ASSAYID)]
data[,NSUB:=as.numeric(NSUB)]
data[,CYTNUM:=as.numeric(CYTNUM)]
data[,NSUB_NEG:=as.numeric(NSUB_NEG)]
data[,CYTNUM_NEG:=as.numeric(CYTNUM_NEG)]
MIMOSA_THRESHOLD_FDR<-0.01
E<-ConstructMIMOSAExpressionSet(data,reference=NULL,measure.columns=c("NSUB","CYTNUM"),.variables=.(PTID,ANTIGEN,TCELLSUB,SAMPLETYPE,CYTOKINE,VISITNO,TESTDT,ASSAYID))
model.frame(NSUB+CYTNUM~PTID+CYTOKINE+ASSAYID|TCELLSUB+VISITNO+ANTIGEN,E)
model.frame(Formula(NSUB+CYTNUM~PTID+CYTOKINE+ASSAYID|TCELLSUB+VISITNO+ANTIGEN),E)
library(Formula)
model.frame(Formula(NSUB+CYTNUM~PTID+CYTOKINE+ASSAYID|TCELLSUB+VISITNO+ANTIGEN),E)
head(model.frame(Formula(NSUB+CYTNUM~PTID+CYTOKINE+ASSAYID|TCELLSUB+VISITNO+ANTIGEN),E))
MIMOSA
getMethod("MIMOSA",c("formula","ExpressionSet"))
getMethod("MIMOSA",c("formula","ExpressionSet")
)
MIMOSA<-getMethod("MIMOSA",c("formula","ExpressionSet"))
debug(MIMOSA)
result<-MIMOSA(NSUB+CYTNUM~PTID+CYTOKINE+ASSAYID|TCELLSUB+VISITNO+ANTIGEN,E,method="mcmc")
n
n
debug(.local)
n
n
n
n
n
n
n
formula
n
head(mf.ref)
head(data)
exprs(dta)
exprs(data)
head(exprs(data))
Q
head(data)
data$NSUB
class(data$NSUB)
class(data$CYTUM)
class(data$CYTNUM)
class(data$CYTNUM_NEG)
class(data$NSUB_NEG)
ConstructMIMOSAExpressionSet
debug(ConstructMIMOSAExpressionSet)
E<-ConstructMIMOSAExpressionSet(data,reference=NULL,measure.columns=c("NSUB","CYTNUM"),.variables=.(PTID,ANTIGEN,TCELLSUB,SAMPLETYPE,CYTOKINE,VISITNO,TESTDT,ASSAYID))
n
reference
n
ref.append.replace
colnames(thisdata)
n
colnames(thisdata)
n
debug(MIMOSAReshape)
head(thisdat)
head(thisdata)
n
c
head(thisdata)
Q
E<-ConstructMIMOSAExpressionSet(data,reference=NULL,measure.columns=c("NSUB","CYTNUM"),.variables=.(PTID,ANTIGEN,TCELLSUB,SAMPLETYPE,CYTOKINE,VISITNO,TESTDT,ASSAYID))
n
default.formula
default.formula
n
default.formula
dfault.cast.formula
default.cast.formula
n
n
Q
colnames(data)
undebug("ConstructMIMOSAExpressionSet")
E<-ConstructMIMOSAExpressionSet(data,reference=NULL,default.cast.formula=component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+VISITNO+TESTDT+ASSAYID+group+group2,measure.columns=c("NSUB","CYTNUM"),.variables=.(PTID,ANTIGEN,TCELLSUB,SAMPLETYPE,CYTOKINE,VISITNO,TESTDT,ASSAYID))
E
head(exprs(E))
debug(ConstructMIMOSAExpressionSet)
E<-ConstructMIMOSAExpressionSet(data,reference=NULL,default.cast.formula=component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+VISITNO+TESTDT+ASSAYID+group+group2,measure.columns=c("NSUB","CYTNUM"),.variables=.(PTID,ANTIGEN,TCELLSUB,SAMPLETYPE,CYTOKINE,VISITNO,TESTDT,ASSAYID))
n
debug(MIMOSAReshape)
n
debug(MIMOSAReshape)
n
default.cast.formula
head(mydata)
summary(mydata)
!grepl("RefTreat", paste(deparse(default.formula), collapse = ""))
as.formula(paste(paste(deparse(default.formula)collapse = ""), "RefTreat", sep = "+"))
as.formula(paste(paste(deparse(default.formula),collapse = ""), "RefTreat", sep = "+"))
n
n
n
paste(cols, "REF", sep = "_")
n
head(melt(mydata, measure.var = c(cols, NEWNAMES)))
n
factor(grepl("_REF$", mydata$variable), labels = c("Treatment", "Reference"))
n
rename(mydata, c(variable = "component", value = "count"))
n
head(mydata)
n
levels(mydata$component)
colnames(mydata)
default.formula
head(mydata)
head(melt(mydata,measure="count"))
head(cast(melt(mydata,measure="count"),default.formula))
?cast
head(cast(melt(mydata,measure="count")))
default.formula
head(cast(melt(mydata,measure="count"),component~))
head(cast(melt(mydata,measure="count"),component~.))
head(cast(melt(mydata,measure="count"),component~...))
head(cast(melt(mydata,measure="count"),component~.))
head(cast(melt(mydata,measure="count")))
head(cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat))
invisible(head(cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)))
head(mydata)
invisible(head(cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)))
mydata$count
head(mydata)
invisible(head(recast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)))
summary(mydata)
default.cast.formula
invisible(head(recast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2)))
head(recast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2))[1]
head(recast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2))[2]
head(recast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat))[2]
any(recast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)>1)
which(recast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)>1)
w<-which(cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)>1)
cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)[w]
w
cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)
w<-which(cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)>1,TRUE)
w
cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)[,w[,2]]
mydata[PTID=="126401000"]
head(mydata)
subset(mydata,PTID=="126401000")
cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)[,w[,2]]
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl)
)
')'
''
)
")
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl")
cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)[,w[,2]]
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl"&TCELLSUB=="CD4+")
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl"&TCELLSUB=="CD4+"&RefTreat=="Reference")
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl"&TCELLSUB=="CD4+"&RefTreat=="Treatment")
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl"&TCELLSUB=="CD4+"&RefTreat=="Treatment"&VISITNO=="2")
cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)[,w[,2]]
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl"&TCELLSUB=="CD4+"&RefTreat=="Treatment"&VISITNO=="15")
cast(melt(mydata,measure="count"),component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+TESTDT+ASSAYID+group+group2+RefTreat)[,w[,2]]
subset(mydata,PTID=="126401000"&ANTIGEN%in%"sebctrl"&TCELLSUB=="CD4+"&RefTreat=="Treatment"&VISITNO=="15")
Q
undebug(ConstructMIMOSAExpressionSet)
E<-ConstructMIMOSAExpressionSet(data,reference=NULL,default.cast.formula=component~PTID+ANTIGEN+TCELLSUB+SAMPLETYPE+CYTOKINE+VISITNO+TESTDT+ASSAYID,measure.columns=c("NSUB","CYTNUM"),.variables=.(PTID,ANTIGEN,TCELLSUB,SAMPLETYPE,CYTOKINE,VISITNO,TESTDT,ASSAYID))
source("repmat.R")
setwd("~/Documents/Projects/model_cpp/")
source("repmat.R")
dyn.load("model.so")
source("realdata_rv144.R")
T = as.integer(2080);
source("init_realdata_rv144.R")
install.packages("e1071")
source("init_realdata_rv144.R")
ttt=as.integer(2000);
source("init_realdata_rv144.R")
install.packages("rBeta2009")
source("init_realdata_rv144.R")
ttt=as.integer(2000);
n_ss = as.integer(n_s); n_uu = as.integer(n_u)
ybars = apply(ybar_s, 3, function(x) as.vector(x))
ybaru = apply(ybar_u, 3, function(x) as.vector(x))
ys2s = apply(ys2_s, 3, function(x) as.vector(x))
ys2u = apply(ys2_u, 3, function(x) as.vector(x))
gammat = apply(gamma,3, function(x) as.integer(x))
gammat
ptm <- proc.time()
result<-.Call("model",T=T,I=I, K=K, M=M, ttt=ttt, SS=as.integer(1),alpha_u=alpha_u, alpha_s=alpha_s, mu_u=mu_u, mu_s=mu_s, alpha=alpha,
beta=beta, gamma=gammat,n_s=n_ss, n_u=n_uu, varp_u=varp_u, lambda_u=lambda_u, indi=indi, d=d, ybar_s = ybars, ybar_u=ybaru,
ys2_s = ys2s, ys2_u = ys2u, a=a, b=b,lambda=lambda,mk = mk, Istar = Istar, mKstar = mKstar, pp = pp, pb1 = pb1,
pb2 = pb2,lambda_s = lambda_s, var_1 = varp_s1,var_2 = varp_s2,p_var = pvar_s, p_vars = pvar_mus,var_1s = sqrt_mus1, var_2s=sqrt_mus2,m_s=m_s,Sigma_s =Sigma_s,
p_varu=pvar_muu,var_1u=sqrt_muu1,var_2u=sqrt_muu2,m_u=m_u, Sigma_u=Sigma_u,p_vara=pvar_alpha, var_1a=sqrt_alpha1,var_2a=sqrt_alpha2,sig_alpha1=sig_alpha1,alpha1=alpha1,
p_varb=pvar_beta,var_1b=sqrt_beta1,var_2b=sqrt_beta2,sig_beta1 = sig_beta1, beta1= beta1, A_alphau=A_alphau,A_alphas=A_alphas, A_gm=A_gm, A_mus=A_mus, A_muu=A_muu,
A_alpha=A_alpha,A_beta=A_beta)
result
set.seed(984)
source("repmat.R")
dyn.load("model.so")
dyn.load("model.so")
version
dyn.load("model.so")
pw
getwd()
library(MIMOSA)
load("~/Downloads/testMIMOSA.rda")
result<-MIMOSA(NSUB+CYTNUM~RefTreat+SIMPLEID,E,ref=RefTreat%in%"Reference",subset=RefTreat%in%"Treatment")
data.frame(pData(result2[[1]]),result[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),2)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),2)[,2])
result2<-MIMOSA(NSUB+CYTNUM~RefTreat+SIMPLEID,E,ref=RefTreat%in%"Reference",subset=RefTreat%in%"Treatment",method="EM")
data.frame(pData(result2[[1]]),result2[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),2)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),2)[,2])
data.frame(pData(result2[[1]]),result[[1]]@z[,2],result2[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),2)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),2)[,2])
data.frame(pData(result2[[1]]),em=result[[1]]@z[,2],mcmc=result2[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),2)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),2)[,2])
data.frame(pData(result2[[1]]),em=result[[1]]@z[,2],mcmc=result2[[1]]@z[,2],dpr=result[[1]]@z[,2]-result2[[1]]@z[,2]dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),2)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),2)[,2])
data.frame(pData(result2[[1]]),em=result[[1]]@z[,2],mcmc=result2[[1]]@z[,2],dpr=result[[1]]@z[,2]-result2[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),2)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),2)[,2])
data
mpc<-read.csv("~/Downloads/MacvsPC.csv")
head(mpc)
with(mpc,CYTNUM/NSUB-CYTNUM_REF/NSUB_REF)
with(mpc,as.numeric(as.character(CYTNUM/NSUB))-as.numeric(as.character(CYTNUM_REF/NSUB_REF)))
mpc<-read.csv("~/Downloads/MacvsPC.csv")
mpc$NSUB<-as.numeric(as.character(mpc$NSUB))
mpc$NSUB_REF<-as.numeric(as.character(mpc$NSUB_REF))
mpc$CYTNUM<-as.numeric(as.character(mpc$CYTNUM))
mpc$CYTNUM_REF<-as.numeric(as.character(mpc$CYTNUM_REF))
with(mpc,CYTNUM/NSUB-CYTNUM_REF)/NSUB_REF)
with(mpc,CYTNUM/NSUB-CYTNUM_REF/NSUB_REF)
with(mpc,CYTNUM/NSUB-(CYTNUM_REF/NSUB_REF))
with(mpc,CYTNUM/NSUB-(CYTNUM_REF/NSUB_REF),mpc)
with(mpc,cbind(CYTNUM/NSUB-(CYTNUM_REF/NSUB_REF),mpc))
with(mpc,cbind(CYTNUM/NSUB-(CYTNUM_REF/NSUB_REF),effect))
with(mpc,cbind(CYTNUM/NSUB-(CYTNUM_REF/NSUB_REF),as.numeric(as.character(effect))))
MIMOSA
fitMCMC
MIMOSA
library(parallel)
result3<-MIMOSA(NSUB+CYTNUM~RefTreat+SIMPLEID,E,ref=RefTreat%in%"Reference",subset=RefTreat%in%"Treatment",run.parallel=TRUE)
data.frame(pData(result2[[1]]),result3[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),2)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),2)[,2])
?prop.table
data.frame(pData(result2[[1]]),result[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
as.matrix(result2[[1]]@result@data$n.stim),1)[,2]
prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)
data.frame(pData(result2[[1]]),result[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
data.frame(pData(result2[[1]]),result2[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
data.frame(pData(result2[[1]]),result3[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
data.frame(pData(result2[[1]]),em=result[[1]]@z[,2],mcmc=result2[[1]]@z[,2],dpr=result[[1]]@z[,2]-result2[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
mpc<-read.csv("~/Downloads/MacvsPC.csv")
mpc$NSUB<-as.numeric(as.character(mpc$NSUB))
mpc$NSUB_REF<-as.numeric(as.character(mpc$NSUB_REF))
mpc$CYTNUM<-as.numeric(as.character(mpc$CYTNUM))
mpc$CYTNUM_REF<-as.numeric(as.character(mpc$CYTNUM_REF))
mpc
with(mpc,cbind((CYTNUM/NSUB)-(CYTNUM_REF/NSUB_REF),as.numeric(as.character(effect))))
with(mpc,cbind(prop.table(cbind(CYTNUM,NSUB),1)[,2]-prop.table(cbind(CYTNUM_REF,NSUB_REF),1)[,2],as.numeric(as.character(effect))))
with(mpc,cbind(prop.table(cbind(NSUB,CYTNUM),1)[,2]-prop.table(cbind(NSUB_REF,CYTNUM_REF),1)[,2],as.numeric(as.character(effect))))
with(mpc,cbind(prop.table(cbind(NSUB,CYTNUM),1)[,2]-prop.table(cbind(NSUB_REF,CYTNUM_REF),1)[,2],effect=as.numeric(as.character(effect)),SIMPLEID))
with(mpc,data.frame(prop.table(cbind(NSUB,CYTNUM),1)[,2]-prop.table(cbind(NSUB_REF,CYTNUM_REF),1)[,2],effect=as.numeric(as.character(effect)),SIMPLEID=SIMPLEID))
raw<-with(mpc,data.frame(prop.table(cbind(NSUB,CYTNUM),1)[,2]-prop.table(cbind(NSUB_REF,CYTNUM_REF),1)[,2],effect=as.numeric(as.character(effect)),SIMPLEID=SIMPLEID))
raw
raw<-data.table(raw)
library(data.table)
raw<-data.table(raw)
setkey(raw,SIMPLEID)
data.frame(pData(result2[[1]]),em=result[[1]]@z[,2],mcmc=result2[[1]]@z[,2],dpr=result[[1]]@z[,2]-result2[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
data.frame(pData(result2[[1]]),result[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
raw
mpc<-read.csv("~/Downloads/MacvsPC.csv")
mpc$NSUB<-as.numeric(as.character(mpc$NSUB))
mpc$NSUB_REF<-as.numeric(as.character(mpc$NSUB_REF))
mpc$CYTNUM<-as.numeric(as.character(mpc$CYTNUM))
mpc$CYTNUM_REF<-as.numeric(as.character(mpc$CYTNUM_REF))
raw<-with(mpc,data.frame(prop.table(cbind(NSUB,CYTNUM),1)[,2]-prop.table(cbind(NSUB_REF,CYTNUM_REF),1)[,2],effect=as.numeric(as.character(effect)),SIMPLEID=SIMPLEID))
raw
raw<-with(mpc,data.frame(pr=prop.table(cbind(NSUB,CYTNUM),1)[,2]-prop.table(cbind(NSUB_REF,CYTNUM_REF),1)[,2],effect=as.numeric(as.character(effect)),SIMPLEID=SIMPLEID))
mpc<-read.csv("~/Downloads/MacvsPC.csv")
mpc$NSUB<-as.numeric(as.character(mpc$NSUB))
mpc$NSUB_REF<-as.numeric(as.character(mpc$NSUB_REF))
mpc$CYTNUM<-as.numeric(as.character(mpc$CYTNUM))
mpc$CYTNUM_REF<-as.numeric(as.character(mpc$CYTNUM_REF))
raw
dim(mpc)
raw<-with(subset(mpc,computer=="PC"),data.frame(pr=prop.table(cbind(NSUB,CYTNUM),1)[,2]-prop.table(cbind(NSUB_REF,CYTNUM_REF),1)[,2],effect=as.numeric(as.character(effect)),SIMPLEID=SIMPLEID))
raw
raw<-data.table(raw)
setkey(raw,SIMPLEID)
raw
data.frame(pData(result2[[1]]),result[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
data.frame(pData(result2[[1]]),z=result[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
df1<-data.frame(pData(result2[[1]]),z=result[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
df1<-data.table(df1)
setkey(df1,SIMPLEID)
raw[df1]
merge(raw,df1)
raw
merge(raw,df1)
df1<-data.frame(pData(result2[[1]]),result3[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
df1<-data.table(df1)
setkey(df1,SIMPLEID)
merge(raw,df1)
library(MIMOSA)
result3<-MIMOSA(NSUB+CYTNUM~RefTreat+SIMPLEID,E,ref=RefTreat%in%"Reference",subset=RefTreat%in%"Treatment",run.parallel=TRUE)
library(MIMOSA)
library(MIMOSA)
result3<-MIMOSA(NSUB+CYTNUM~RefTreat+SIMPLEID,E,ref=RefTreat%in%"Reference",subset=RefTreat%in%"Treatment",run.parallel=TRUE)
df1<-data.frame(pData(result2[[1]]),result3[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
df1<-data.table(df1)
setkey(df1,SIMPLEID)
setkey(raw,SIMPLEID)
merge(raw,df1)
mclalpply(1:100,rnorm(!))
mclalpply(1:100,rnorm(1))
mclapply(1:100,rnorm(1))
library(parallel)
mclapply
mclapply(1:100,rnorm(1))
mclapply(1:100,function(X)rnorm(1))
mclapply(1:100,function(x)rnorm(1))
do.call(c,mclapply(1:100,function(x)rnorm(1)))
hist(do.call(c,mclapply(1:100,function(x)rnorm(1))))
library(MIMOSA)
library(MIMOSA)
Sys.info()['sysname']
layer(sp)
library(MIMOSA)
result3<-MIMOSA(NSUB+CYTNUM~RefTreat+SIMPLEID,E,ref=RefTreat%in%"Reference",subset=RefTreat%in%"Treatment",run.parallel=TRUE)
df1<-data.frame(pData(result2[[1]]),result3[[1]]@z[,2],dp=prop.table(as.matrix(result2[[1]]@result@data$n.stim),1)[,2]-prop.table(as.matrix(result2[[1]]@result@data$n.unstim),1)[,2])
raw<-data.table(raw)
df1<-data.table(df1)
setkey(df1,SIMPLEID)
setkey(raw,SIMPLEID)
merge(raw,df1)
library(MIMOSA)
result3<-MIMOSA(NSUB+CYTNUM~RefTreat+SIMPLEID,E,ref=RefTreat%in%"Reference",subset=RefTreat%in%"Treatment",run.parallel=TRUE)
